<script>
    function format(n) {
        if(isNaN(n) || n==="") return "";
        return parseFloat(n).toLocaleString("en-US", {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function calc() {
        var sales = +document.getElementById('sales').value || 0;
        var ibs = +document.getElementById('inter-branch-sale').value || 0;
        var excard = +document.getElementById('vat-ex-card').value || 0;
        var exoth = +document.getElementById('vat-ex-other').value || 0;
        var vatable_sales = sales - ibs - excard - exoth;
        var vat_sale = vatable_sales * 0.05;
        var sys_output_vat = +document.getElementById('system-output-vat').value || 0;
        var output_vat_diff = vat_sale - sys_output_vat;
        var amount_as_per_diff_output = output_vat_diff / 0.05;
        var purchase = +document.getElementById('purchase').value || 0;
        var purch_ret = +document.getElementById('purchase-return').value || 0;
        var netpurch = purchase - purch_ret;
        var telecard = +document.getElementById('telecard').value || 0;
        var ibpurch = +document.getElementById('inter-branch-purch').value || 0;
        var imprt = +document.getElementById('import').value || 0;
        var unreg = +document.getElementById('unreg-purchase').value || 0;
        var after_less = netpurch - telecard - ibpurch - imprt - unreg;
        var vat_purch = after_less * 0.05;
        var sys_input_vat = +document.getElementById('system-input-vat').value || 0;
        var input_vat_diff = vat_purch - sys_input_vat;
        var amount_as_per_diff_input = input_vat_diff / 0.05;
        var input_vat_exp = +document.getElementById('input-vat-exp').value || 0;

        document.getElementById('total-sales').textContent = sales ? format(sales) : "";
        document.getElementById('total-vatable-sales').textContent = (sales || ibs || excard || exoth) ? format(vatable_sales) : "";
        document.getElementById('vat-on-vatable-sales').textContent = vatable_sales ? format(vat_sale) : "";
        document.getElementById('output-vat-difference').textContent = (vat_sale || sys_output_vat) ? format(output_vat_diff) : "";
        document.getElementById('amount-as-per-diff-output-vat').textContent = output_vat_diff ? format(amount_as_per_diff_output) : "";
        document.getElementById('total-output-vat').textContent = (vatable_sales) ? format(vat_sale) : "";
        document.getElementById('total-purchase').textContent = purchase ? format(purchase) : "";
        document.getElementById('total-net-purchase').textContent = (purchase || purch_ret) ? format(netpurch) : "";
        document.getElementById('total-after-less').textContent = (purchase || purch_ret || telecard || ibpurch || imprt || unreg) ? format(after_less) : "";
        document.getElementById('vat-on-net-purchase').textContent = after_less ? format(vat_purch) : "";
        document.getElementById('input-vat-difference').textContent = (vat_purch || sys_input_vat) ? format(input_vat_diff) : "";
        document.getElementById('amount-as-per-diff-input-vat').textContent = input_vat_diff ? format(amount_as_per_diff_input) : "";
        document.getElementById('total-input-vat').textContent = after_less ? format(vat_purch) : "";
        document.getElementById('out-vat-sales').textContent = (vatable_sales) ? format(vat_sale) : "";
        document.getElementById('in-vat-purch').textContent = after_less ? format(vat_purch) : "";
        document.getElementById('in-vat-exp').textContent = input_vat_exp ? format(input_vat_exp) : "";
        var vat_payable = vat_sale - vat_purch - input_vat_exp;
        document.getElementById('vat-payable').textContent = (vatable_sales || after_less || input_vat_exp) ? format(vat_payable) : "";
        var now = new Date();
        var day = String(now.getDate()).padStart(2, '0');
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var year = now.getFullYear();
        var hour = String(now.getHours()).padStart(2, '0');
        var minute = String(now.getMinutes()).padStart(2, '0');
        var second = String(now.getSeconds()).padStart(2, '0');
        var datetime = `${day}/${month}/${year} ${hour}:${minute}:${second}`;
        document.getElementById('date-time').textContent = datetime;
    }

    function populateForm(data) {
        document.getElementById('branch-name').value = data.branch;
        document.getElementById('prepared-by').value = data.prepared_by;
        document.getElementById('sales').value = data.sales;
        document.getElementById('inter-branch-sale').value = data.inter_branch_sale;
        document.getElementById('vat-ex-card').value = data.vat_ex_card;
        document.getElementById('vat-ex-other').value = data.vat_ex_other;
        document.getElementById('system-output-vat').value = data.system_output_vat;
        document.getElementById('purchase').value = data.purchase;
        document.getElementById('purchase-return').value = data.purchase_return;
        document.getElementById('telecard').value = data.telecard;
        document.getElementById('inter-branch-purch').value = data.inter_branch_purch;
        document.getElementById('import').value = data.import;
        document.getElementById('unreg-purchase').value = data.unreg_purchase;
        document.getElementById('system-input-vat').value = data.system_input_vat;
        document.getElementById('input-vat-exp').value = data.input_vat_exp;

        // Disable all inputs
        document.querySelectorAll('input, select').forEach(el => {
            el.disabled = true;
        });

        // Re-calculate to show final values
        calc();
    }
    
    window.onload = function() {
        if(window.location.search) {
            // This is a placeholder for future functionality if you pass data via URL
            // For now, it will simply run the calc function.
        } else {
            calc();
            setInterval(calc, 1500);
        }
    };
    
    document.getElementById('submitSheetBtn').onclick = function(e) {
        e.preventDefault();
        calc();
        function gatherVATFormData() {
            try {
                return {
                    "Branch": document.getElementById('branch-name').value,
                    "Period": document.getElementById('date-time').textContent,
                    "Sales": document.getElementById('sales').value,
                    "Inter-Branch Sale": document.getElementById('inter-branch-sale').value,
                    "VAT Exempted Sale (CARD)": document.getElementById('vat-ex-card').value,
                    "VAT Exempted Sale (OTHERS)": document.getElementById('vat-ex-other').value,
                    "Vatable Sales": document.getElementById('total-vatable-sales').textContent,
                    "VAT on Vatable Sales": document.getElementById('vat-on-vatable-sales').textContent,
                    "Output VAT as per System": document.getElementById('system-output-vat').value,
                    "Output VAT Difference": document.getElementById('output-vat-difference').textContent,
                    "Sale Amount as per Difference": document.getElementById('amount-as-per-diff-output-vat').textContent,
                    "Total Output VAT": document.getElementById('total-output-vat').textContent,
                    "Purchase": document.getElementById('purchase').value,
                    "Purchase Return": document.getElementById('purchase-return').value,
                    "Tele Card Purchase": document.getElementById('telecard').value,
                    "Inter-Branch Purchase": document.getElementById('inter-branch-purch').value,
                    "Import": document.getElementById('import').value,
                    "Unregistered Purchase": document.getElementById('unreg-purchase').value,
                    "Net Purchase": document.getElementById('total-net-purchase').textContent,
                    "After Less": document.getElementById('total-after-less').textContent,
                    "VAT on Net Purchase": document.getElementById('vat-on-net-purchase').textContent,
                    "Input VAT as per System": document.getElementById('system-input-vat').value,
                    "Input VAT Difference": document.getElementById('input-vat-difference').textContent,
                    "Purchase Amount as per Difference": document.getElementById('amount-as-per-diff-input-vat').textContent,
                    "Total Input VAT": document.getElementById('total-input-vat').textContent,
                    "Input VAT on Expense": document.getElementById('input-vat-exp').value,
                    "Output VAT (Sales)": document.getElementById('out-vat-sales').textContent,
                    "Input VAT (Purchase)": document.getElementById('in-vat-purch').textContent,
                    "Input VAT (Expense)": document.getElementById('in-vat-exp').textContent,
                    "VAT Payable": document.getElementById('vat-payable').textContent,
                    "Prepared By": document.getElementById('prepared-by').value
                };
            } catch(e) {
                alert("A field referenced in the script does not exist in your HTML.\nError: " + e.message);
                throw e;
            }
        }
        const data = gatherVATFormData();
        fetch('https://script.google.com/macros/s/AKfycbypl7HflBBMP1wZjvN9CYMNeSfHlosT8zfiUFrMcS0IIx1LwBcfub3u_7W9l963K8Ug/exec', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {'Content-Type': 'application/json'}
        })
        .then(res => res.text())
        .then(resp => {
            document.querySelector('.submit-area').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            populateForm(data);
        })
        .catch(() => alert('Submission failed. Please check your network and try again.'));
    };

    function downloadCSV() {
        const data = {
            "Branch": document.getElementById('branch-name').value,
            "Period": document.getElementById('date-time').textContent,
            "Sales": document.getElementById('sales').value,
            "Inter-Branch Sale": document.getElementById('inter-branch-sale').value,
            "VAT Exempted Sale (CARD)": document.getElementById('vat-ex-card').value,
            "VAT Exempted Sale (OTHERS)": document.getElementById('vat-ex-other').value,
            "Vatable Sales": document.getElementById('total-vatable-sales').textContent,
            "VAT on Vatable Sales": document.getElementById('vat-on-vatable-sales').textContent,
            "Output VAT as per System": document.getElementById('system-output-vat').value,
            "Output VAT Difference": document.getElementById('output-vat-difference').textContent,
            "Sale Amount as per Difference": document.getElementById('amount-as-per-diff-output-vat').textContent,
            "Total Output VAT": document.getElementById('total-output-vat').textContent,
            "Purchase": document.getElementById('purchase').value,
            "Purchase Return": document.getElementById('purchase_return').value,
            "Tele Card Purchase": document.getElementById('telecard').value,
            "Inter-Branch Purchase": document.getElementById('inter-branch-purch').value,
            "Import": document.getElementById('import').value,
            "Unregistered Purchase": document.getElementById('unreg-purchase').value,
            "Net Purchase": document.getElementById('total-net-purchase').textContent,
            "After Less": document.getElementById('total-after-less').textContent,
            "VAT on Net Purchase": document.getElementById('vat-on-net-purchase').textContent,
            "Input VAT as per System": document.getElementById('system-input-vat').value,
            "Input VAT Difference": document.getElementById('input-vat-difference').textContent,
            "Purchase Amount as per Difference": document.getElementById('amount-as-per-diff-input-vat').textContent,
            "Total Input VAT": document.getElementById('total-input-vat').textContent,
            "Input VAT on Expense": document.getElementById('input-vat-exp').value,
            "Output VAT (Sales)": document.getElementById('out-vat-sales').textContent,
            "Input VAT (Purchase)": document.getElementById('in-vat-purch').textContent,
            "Input VAT (Expense)": document.getElementById('in-vat-exp').textContent,
            "VAT Payable": document.getElementById('vat-payable').textContent,
            "Prepared By": document.getElementById('prepared-by').value
        };

        let csv = "Particulars,Amount\n";
        for (const key in data) {
            const value = data[key] ? data[key].replace(/"/g, '""') : '';
            csv += `"${key}","${value}"\n`;
        }

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "vat-submission.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function newSubmission() {
        // Show the form and hide the success message
        document.querySelector('.submit-area').style.display = 'block';
        document.getElementById('success-message').style.display = 'none';

        // Reset all input fields
        document.querySelectorAll('input, select').forEach(el => {
            if (el.id !== 'branch-name') { // Keep the branch name selected
                el.value = "";
            }
            el.disabled = false;
        });

        // Recalculate to clear all values in the calc-cells
        calc();
    }
</script>